<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <meta content="text/html; charset=ISO-8859-1"
      http-equiv="Content-Type">
    <title>SQLToolKit/Sequence Documentation</title>
  </head>
  <body>
    <h1>SQLToolKit/Sequence</h1>
    <span style="font-weight: bold;"></span>
    <h2>Overview</h2>
    SQLToolKit/Sequence (or STK/Sequence, or just Sequence) is an
    implementation of SQL Sequences which uses MariaDB's Stored
    Routines.<br>
    The implementation follows PostgreSQL's manual pages as a guideline,
    but there are some differences.<br>
    <br>
    A Sequence is a database object that acts as a counter. Sequence's
    values are meat to be unique in the whole server. When you read the
    next value, the Sequence advances and you can use the value.<br>
    Sequence's properties are minimum value, maximum value, increment
    and start value. Usually, increment is +1 and start value is the
    minimum value. But you can set any increment, even a negative
    number. If increment is negative, start value is usually the maximum
    number.<br>
    A Sequence can be rotating or not-rotating. If a Sequence can
    rotate, when it reaches the limit it rotates. This means that if the
    increment is positive, when maximum value is reached, the Sequence
    restarts from minimum value; if the increment is negative, when
    minimum value is reached, the Sequence restarts from maximum values.<br>
    Please note that an increment = 0 is allowed. Usually it does not
    make sense, but if you know what you are doing you can use it.<br>
    <h2>Credits<br>
    </h2>
    <span style="font-weight: bold;">Contact the author to ask for info,
      pay for support, or pay for a new feature.</span><br>
    <br>
    Federico Razzoli<br>
    Email:
    <!-- a 
    -->santec<!-- b -->@<!-- 
    c
    -->riseup<!-- d -->.<!-- e
    -->net<!-- f --><br>
    Blog (en): <a href="http://falseisnotnull.wordpress.com/">FALSE IS
      NOT NULL</a><br>
    Blog (it): <a href="http://falsenonenull.wordpress.com/">FALSE non
      &egrave; NULL</a><br>
    <h2>License</h2>
    This manual is licensed under a <a rel="license"
      href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative
      Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License</a>.<br>
    <br>
    As noted in the source code, STK/Sequence is released under the
    terms of <a href="http://www.gnu.org/licenses/agpl-3.0.html">GNU
      Affero General Public License (AGPL), version 3</a>. You should
    have received the license with Sequence: it's the file named
    'COPYING'. If you did not receive it, please follow the link to the
    license and read it.<br>
    <h2>System requirements</h2>
    Sequence is developed and tested with MariaDB 5.5. No plugins
    required. Any OS.<br>
    <br>
    It can't work with MariaDB older versions and MySQL.<br>
    <br>
    Feedback about Percona Server is welcome.<br>
    <h2>Installation</h2>
    If you want to use a graphical/web client, you can paste the whole
    contents of <span style="font-family: monospace;">sequence.sql</span>
    into your client and execute it.<br>
    <br>
    If you want to use the command-line client, you can execute:<br>
    <span style="font-family: monospace;">mysql &lt;
      path/to/sequence.sql</span><br>
    <br>
    To uninstall, just delete the `sk_sequence` database.<br>
    <h2>Getting started</h2>
    Here is a simple example - but you can do more than this:<br>
    <br>
    <span style="font-family: monospace;">-- create sequence:
      increment=5, min_value=1, max_value=100, start from 10.</span><br
      style="font-family: monospace;">
    <span style="font-family: monospace;">-- TRUE means that when
      my_sequence reaches max_value, it rotates.</span><br
      style="font-family: monospace;">
    <span style="font-family: monospace;">CALL
      `stk_sequence`.`create`('my_sequence', 5, 1, 100, TRUE, 10,
      'This is a comment');</span><br style="font-family: monospace;">
    <span style="font-family: monospace;">-- changed my mind.
      min_value=1000, max_value=5000</span><br style="font-family:
      monospace;">
    <span style="font-family: monospace;">CALL
      `stk_sequence`.`alter`('my_sequence', NULL, 1000, 2000,
      NULL, NULL, NULL);</span><br style="font-family: monospace;">
    <span style="font-family: monospace;">-- rename it</span><br
      style="font-family: monospace;">
    <span style="font-family: monospace;">CALL
      `stk_sequence`.`rename`('my_sequence', 'her_sequence');</span><br
      style="font-family: monospace;">
    <span style="font-family: monospace;">-- increment value!</span><br
      style="font-family: monospace;">
    <span style="font-family: monospace;">SELECT
      `stk_sequence`.nextval('her_sequence'); -- 1000</span><br
      style="font-family: monospace;">
    <span style="font-family: monospace;">SELECT
      `stk_sequence`.nextval('her_sequence'); -- 1001</span><br
      style="font-family: monospace;">
    <span style="font-family: monospace;">SELECT
      `stk_sequence`.nextval('her_sequence'); -- 1002 ...</span><br
      style="font-family: monospace;">
    <span style="font-family: monospace;">-- read last value generated
      by this session for her_sequence</span><br style="font-family:
      monospace;">
    <span style="font-family: monospace;">SELECT
      `stk_sequence`.currval('her_sequence');</span><br
      style="font-family: monospace;">
    <span style="font-family: monospace;">-- read last value generated
      by this session for any sequece</span><br style="font-family:
      monospace;">
    <span style="font-family: monospace;">SELECT
      `stk_sequence`.lastval();</span><br style="font-family:
      monospace;">
    <span style="font-family: monospace;">-- drop sequence</span><br
      style="font-family: monospace;">
    <span style="font-family: monospace;">CALL
      `stk_sequence`.`drop`('her_sequence');</span><br
      style="font-family: monospace;">
    <span style="font-family: monospace;">SELECT
      `stk_sequence`.`exists`('her_sequence'); -- 0</span><br>
    <h2>Routines reference</h2>
    <h3>Information Routines</h3>
    <span style="font-family: monospace;">VOID version()</span><br>
    Returns version info.<br>
    <h3>Sequence Definition</h3>
    <span style="font-family: monospace;">VOID
      create(sequence_name, increment, min_value, max_value,
      cycle, start, comment)</span><br>
    Creates a new Sequence. Parameters are used to set the Sequence's
    properties, as explained below. For properties having a default
    value, you can use that default value by passing NULL.<br>
    <span style="font-weight: bold;">sequence_name</span> is the name of
    the sequence. Names must be unique. Only ASCII characters can be
    used. Names are case sensitive. Maximum lenght is 64. No other
    constraints: '...' is a valid name.<br>
    <span style="font-weight: bold;">increment</span> is a integer
    number. Each time you read the current value using nextval(), the
    increment will be added. It can be a negative number (decrement).
    Set to 0 to stop the Sequence. Default is 1.<br>
    <span style="font-weight: bold;">min_value</span> is the minimum
    value which the Sequence can use. If increment is &gt;= 0, default
    min_value is 0; else it's (minimum BIGINT SIGNED) + increment.<br>
    <span style="font-weight: bold;">max_value</span> is the maximum
    value which the Sequence can use. If increment is &gt;= 0, default
    max_value is (maximum BIGINT SIGNED) + increment; else, it's -1.<br>
    <span style="font-weight: bold;">cycle</span> is a BOOLEAN. If it's
    TRUE, when the current value can not be incremented/decremented
    anymore, it rotates. Else, it will just raise an error. Please note
    that is min_value is 1, max_value is 10, increment is 5 and current
    value is 7, if it can rotate, it will be set to 2. If increment is
    6, value will be set to 3.<br>
    <span style="font-weight: bold;">start</span> is the value that will
    be used when nextval() is called for the first time on this
    Sequence. After this call, this value will never be used again. If
    increment is &gt;= 1, default start is min_value; else, it's
    max_value.<br>
    <span style="font-weight: bold;">comment</span> is a comment that
    will be associated to the Sequence.<br>
    <br>
    <span style="font-family: monospace;">VOID
      alter(sequence_name, increment, min_value, max_value,
      cycle, comment)</span><br>
    Modifies 0 or more properties of the Sequence. See <span
      style="font-family: monospace;">create()</span> for a
    description of the parameters. Please note that NULL means "leave
    this property unchanged". With <span style="font-family:
      monospace;">alter()</span>, if you want to set a property
    to its default value, you must pass the value explicitly. The start
    property can not be changed (it would make no sense). Also, if you
    want to rename the Sequence, you need to use <span
      style="font-family: monospace;">rename()</span>.<br>
    <br>
    <span style="font-family: monospace;">VOID `rename`(old_name,
      new_name)</span><br>
    Renames the Sequence called old_name to new_name. If the Sequence
    does not exist, an error is generated.<br>
    <br>
    <span style="font-family: monospace;">VOID
      drop(sequence_name)</span><br>
    Drops a Sequence if it exists; else, an error is generated.<br>
    <br>
    <span style="font-family: monospace;">BOOL
      exists(sequence_name)</span><br>
    Returns TRUE if a Sequence called sequence_name exists, else FALSE.<br>
    <br>
    <span style="font-family: monospace;">VOID
      get(sequence_name, OUT increment, OUT min_value, OUT
      max_value, OUT cycle, OUT comment)</span><br>
    Retrieves info about the Sequence called sequence_name. increment,
    min_value, max_value, cycle and comment will be set with the
    Sequence's properties.<br>
    <h3>Sequence Manipulation/Query</h3>
    <span style="font-family: monospace;">BIGINT SIGNED
      netxval(sequence_name)</span><br>
    Increments the specified Sequence's current value and returns it. If
    nextval() has never been called for this Sequence, its current value
    will be set to the start property. If the specified Sequence has
    reached its max_value/min_value, and it can not rotate, an error is
    issued.<br>
    <br>
    <span style="font-family: monospace;">BIGINT SIGNED
      currval(sequence_name)</span><br>
    Returns the last value generated for this session by the specified
    Sequence. If the Sequence does not exist, returns FALSE.<br>
    <br>
    <span style="font-family: monospace;">BIGINT SIGNED lastval()</span><br>
    Returns the last value generated for this session by any Sequence.<br>
    <br>
    <span style="font-family: monospace;">BIGINT SIGNED
      setval(sequence_name, new_value, is_called)</span><br>
    Sets the current value of the specified Sequence to new_value.<br>
    If is_called is TRUE:
    <ul>
      <li>currval() will return the specified value;</li>
      <li>nextval() increment that value before returning the new value.</li>
    </ul>
    If is_called is FALSE:
    <ul>
      <li>currval() will not return the specified value (it will return
        the last generated value);</li>
      <li>nextval() will return the specified value.</li>
    </ul>
    Note: PostgreSQL users may think that third parameter is optional,
    but it is not.<br>
    <ul>
      <ul>
      </ul>
    </ul>
    <h3>Errors</h3>
    When you call Sequence routines in a wrong way, there are 2 cases:<br>
    <ul>
      <li>You get an error.</li>
      <li>You don't get any error, because you may know what you are
        doing. It's something dirty, but you may exactly know what you
        are doing.</li>
    </ul>
    All errors generated by Sequence set SQLSTATE to 45000. Messages are
    in the following form:<br>
    '[stk_sequence.routine_name] - Error message'<br>
    This helps debugging, because the first part tells you:<br>
    <ul>
      <li>That the error was generated by Sequence.</li>
      <li>The name of the routine which generated the error.</li>
    </ul>
    <h2>Implementation details</h2>
    All Sequences are stored in a `stk_sequence`.`SEQUENCES`. Its column
    names follow the style used for the `information_schema` tables.
    However you should never INSERT/UPDATE/DELETE from `SEQUENCES`.
    Also, my advice is to use get(), rather that SELECTing from
    that table.<br>
    <br>
    SELECT ... FOR UPDATE is used internally to lock `SEQUENCES`, which
    uses XtraDB (InnoDB). This assures that Sequences are thread-safe.<br>
    <br>
    The last values read by the current session are stored in a
    temporary MEMORY table, which is created when needed.<br>
    <br>
    Sequences values are BIGINT SIGNED. Some notes about this choice:<br>
    <ul>
      <li>Commonly, Sequences generate integer values.<br>
      </li>
      <li>Using BIGINT as PRIMARY KEY is generally a bad practice. So,
        you are not supposed to need values which are higher than the
        limit of BIGINT SIGNED.</li>
      <li>In some cases, you may want to use negative values. It's
        probably rare, but it's possible.</li>
      <li>Changing BIGINT SIGNED to another integer value is not so
        difficult: just replace all occurrences of INTEGER SIGNED.<br>
      </li>
    </ul>
    <h2>STK/Sequence and the future</h2>
    If current implementation works good, there is no reason to
    add/modify something. Unless users or paying clients ask for a new
    feature. Paying is the most reliable method to ask a feature. If you
    are considering this option, please contact the author.<br>
    <br>
    What will be done for sure:<br>
    <ul>
      <li>Bug fixes.<br>
      </li>
      <li>Keep the project updated, to be sure that will work correctly
        (and as fast as possible) with future versions of MariaDB.</li>
      <li>Paid technical support, if someone asks.</li>
      <li>Free support for projects I may choose to support for
        political reasons.<br>
      </li>
    </ul>
    Things that you may want to request:<br>
    <ul>
      <li>Temporary (session) sequences.<br>
      </li>
      <li>String sequences.<br>
      </li>
      <li>Datetime sequences.</li>
      <li>Triggers before/after value generation.<br>
      </li>
      <li>I don't know.<br>
      </li>
    </ul>
    <br>
    <br>
  </body>
</html>
